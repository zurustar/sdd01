# ステップ3に進む前の保留作業

このリストは、ステップ3（ドキュメント作成とレビュー）に進む前に、ステップ1とステップ2（テスト先行開発と実装／ブラッシュアップ）で完了させる必要がある未完了タスクをまとめたものです。

- [v] 001. docs/pre_step3_todo.md に掲載された各タスクにユニークな番号を割り当てる
## テストの足場作り（ステップ1）
- [v] 002. （作業計画）HTTP ミドルウェアコンポーネントテストの骨組みを追加する。
- [v] 003. （作業計画）繰り返しエンジンのテスト骨組みを導入する。
- [v] 004. （作業計画）永続化アダプター向けのテスト骨組みを整備する。
- [v] 005. （作業計画）永続化アダプターにおける無効レコード検証テスト骨組みを拡張する。
- [v] 006. （作業計画）永続化アダプターの大小文字変換／順序保証テスト骨組みを整備する。
- [v] 007. （作業計画）繰り返しリポジトリに関するテスト骨組みを追加する。
- [v] 008. （作業計画）SQLite ストレージの既存挙動をカバーするテスト骨組みを拡張する。
- [v] 009. （作業計画）SQLite ストレージのタイムスタンプ往復テスト骨組みを追加する。
- [v] 010. （作業計画）平日ビットマスクの往復テスト骨組みを拡張する。
- [v] 011. （作業計画）セッション管理リポジトリのテスト骨組みを追加する。
- [v] 012. （作業計画）HTTP ハンドラー群のコンポーネントテスト骨組みを概説する。
- [v] 013. （作業計画）スケジュール一覧 HTTP ハンドラーのテスト骨組みを追加する。
- [v] 014. （作業計画）構成ローダーのテスト骨組みを作成する。
- [v] 015. スケジュールサービスのテスト骨組みを拡張し、参加者フィルターや期間変換などの一覧要件、競合警告伝播、時系列順序をカバーするケースを追加する。
- [v] 016. `ListSchedules` のテスト骨組みを記述し、デフォルトビューと明示的な参加者フィルターの挙動を検証するケースを用意する。
- [v] 017. スケジュールサービスの更新／削除に関する認可と `ErrUnauthorized`／`ErrNotFound` 伝播テストを整備する。
- [v] 018. `RoomService` の CRUD および `ListRooms` のアクセス制御テスト骨組みを補完する。
- [v] 019. 管理者専用のユーザー管理サービステスト骨組みを補完し、権限と入力検証をカバーする。
- [v] 020. 認証サービスのテスト骨組みを補完し、パスワードハッシュ、セッション発行、センチネルエラーをカバーする。
- [v] 021. `internal/scheduler` の競合検出テスト骨組みを拡張し、参加者と会議室の同時競合を検証する。
- [v] 022. スケジュールアプリケーションサービスの各メソッド（`CreateSchedule`、`UpdateSchedule`、`ListSchedules`、`DeleteSchedule`）について、作成者の不変性、管理者の上書き、開始／終了時間と必須項目（ウェブ会議URL形式を含む）の検証、参加者と会議室の存在確認、他ユーザーの代理でのスケジュール作成、物理会議室とウェブ会議情報を同時に設定できるハイブリッド会議の許可をカバーする失敗テストの骨組みを充実させる。
- [v] 023. スケジュールサービスのテスト骨組みを拡張し、参加者フィルター、複数ユーザーの一覧表示、繰り返し展開フック、検出器からの競合警告伝播、返却されるスケジュールの時系列順序付け、スケジュール更新／削除時の関連する繰り返し設定のクリーンアップ、JST（日本標準時）のみのスケジューリング強制、日／週／月の期間フィルター（`StartsAfter`／`EndsBefore`）を正しい結果セットに変換すること、警告が報告されても更新を永続化する成功パスを確認するケースを追加する。
- [v] 024. `ListSchedules` のテスト骨組みを記述し、デフォルトビュー（参加者フィルターが指定されていない場合）が認証済みユーザー自身のスケジュールのみを返す一方で、明示的な参加者フィルターによって同僚のスケジュールを閲覧できるようにし、「自分のスケジュール」と「選択した同僚」の要件に一致しながら意図しないレコードが漏えいしないことを確認する。
- [v] 025. 作成者以外が更新や削除を試みた際の認可失敗、管理者の上書き成功パス、存在しないスケジュールに対する `ErrUnauthorized`／`ErrNotFound` の一貫した伝播をカバーするスケジュールサービスのテスト骨組みを追加する。
- [v] 026. `RoomService` の CRUD 挙動を対象に、管理者のみアクセス可能な制約と必須属性（名前、所在地、正の収容人数）の検証を含むユニットテスト骨組みを追加する。
- [v] 027. スケジュール作成フローが会議室カタログを表示できるよう、`RoomService.ListRooms` の骨組みにおいてすべての認証済み従業員（管理者だけでなく）が読み取りアクセスできることを確認する。
- [v] 028. 管理者専用のユーザー管理サービスメソッド（`CreateUser`、`UpdateUser`、`ListUsers`、`DeleteUser`）について、入力処理と権限強制を検証するユニットテスト骨組みを作成する。
- [v] 029. 認証サービスのユニットテスト骨組みを作成し、パスワードハッシュのエッジケース、ロックアウト動作（維持する場合）、セッション／トークン発行フロー、無効な資格情報や無効化済みアカウントに対するセンチネルエラーを含める。
- [v] 030. `internal/scheduler` の競合検出ユニットテスト骨組みを強化し、参加者および会議室の時間帯重複、同一IDのショートサーキット動作、サービスを検出器に配線する前の非重複のベースラインを記述する。
- [v] 031. 参加者と会議室の両方が同時に重複するスケジュールをカバーし、検出器が単一の評価で該当する警告をすべて返すことを確認する競合検出骨組みを拡張する。
- [v] 032. HTTP ミドルウェア／コンポーネントテストを記述し、セッショントークン検証と認証済みプリンシパルをハンドラーのコンテキストへ伝播することを確認する。
- [v] 033. 平日選択、タイムゾーン処理、要求された期間への生成発生のクリッピング、生成された発生のリンク付けを記述する繰り返しエンジンのテスト概要を導入する。
- [v] 034. 永続化アダプター（ユーザー、スケジュール、会議室、繰り返し、認証データのリポジトリ）に関するテスト骨組みを定義し、SQLite フィクスチャを使った統合テストのプレースホルダー、外部キーのカスケードカバレッジ、重複／検索違反のセンチネルエラーへの変換を含める。
- [v] 035. `End` が `Start` より後になっていないスケジュール、正の値でない会議室の収容人数、`EndsOn` が `StartsOn` より前の繰り返しなど、無効なレコードをリポジトリが拒否し、それらの制約違反に対する計画済みの検証センチネルエラーを表面化することを主張する永続化アダプター骨組みを拡張する。
- [v] 036. `GetUserByEmail` が大文字小文字を区別しない検索を実行し、リポジトリの一覧操作（`ListUsers`、`ListRooms`、`ScheduleRepository.ListSchedules`）が決定論的な順序で結果を返し、スケジュール参加者のコレクションがソート済みで重複が除去されて戻ることを確認する永続化アダプター骨組みを拡張する。
- [v] 037. `UpsertRecurrence` が更新時に元の `CreatedAt` タイムスタンプを保持し、`StartsOn`／`EndsOn` の境界をタイムゾーンドリフトなく往復し、`ListRecurrencesForSchedule` がルールを作成順に返すことを検証する繰り返しリポジトリ骨組みを追加する。
- [v] 038. `internal/persistence/sqlite` に現在組み込まれている DSN 正規化、`PRAGMA foreign_keys` の強制、トランザクションのロールバックセマンティクスを捉え、純粋な Go ドライバーのリファクタリング後もこれらの挙動が維持されるようにする SQLite ストレージテスト骨組みを拡張する。
- [v] 039. タイムスタンプ列が UTC の `time.RFC3339Nano` 形式で往復し続けることを主張し、database/sql への移行でタイムゾーン処理が後退したり精度が切り捨てられたりしないようにする SQLite ストレージテスト骨組みを追加する。
- [v] 040. 繰り返しの平日ビットマスクエンコードをカバーし、`[]time.Weekday` と整数列との間で複数日の選択が正しく往復するようにする SQLite ストレージテスト骨組みを拡張する。
- [v] 041. トークン作成、検索、期限切れ、取り消し動作をカバーするセッション管理リポジトリ向けの永続化テスト骨組みを追加する。
- [v] 042. 認証、ユーザー管理、スケジュール、会議室の HTTP ハンドラーに関するコンポーネントテスト骨組みを概説し、リクエスト検証、認可（非作成者に対する403レスポンスを含む）、レスポンス構成、ログインによるセッショントークンの設定（Cookie／ヘッダー）、ログアウト時のセッション取り消し、競合警告と繰り返し展開結果の提示、仕様に沿ったローカライズされた（日本語の）エラーおよび検証メッセージの返却を検証する。
- [v] 043. スケジュール一覧に関する HTTP ハンドラーテスト骨組みを追加し、デフォルトの個人ビュー、明示的な同僚選択、欠落または禁止されたスケジュールリソースに対して `ErrNotFound`／`ErrUnauthorized` をそれぞれ `404`／`403` に変換すること、曜日／週／月のクエリパラメーターのマッピング（週は月曜開始、デフォルトの日次時間範囲を含む）がサービスの期間フィルターへ正しく変換されることを確認する。
- [v] 044. 環境変数の解析、デフォルトフォールバック動作、必須設定（HTTP ポート、SQLite DSN、セッションシークレット）の検証を確認する構成ローダーのテスト骨組みを作成し、ステップ2の作業がテストファーストで進められるようにする。

## グリーンフェーズを解放するための実装（ステップ2）
- [v] 045. 既存の競合検出ロジックをスケジュールの作成／更新フローに組み込み、警告が存在しても変更を永続化しつつ、サービスとハンドラーのレスポンスで競合警告が表面化するようにし、「警告は処理をブロックしない」というルールに一致させる。
  - [v] 046. (作業計画) `ScheduleService` と HTTP ハンドラーが競合検出結果を返却しつつ永続化が成功することを確認し、未達の分岐を実装する。
    - [v] 047. (実装) `ScheduleService` の作成／更新テストを補強し、競合警告が返ってきても永続化が継続されることを確認する。
    - [v] 048. (実装) スケジュール更新ハンドラーがサービスから受け取った競合警告を `warnings` としてシリアライズすることを検証するテストを追加する。
  - [v] 049. `ScheduleService` を競合検出コンポーネントに接続し、作成／更新時に検出結果を返すようにする。
  - [v] 050. スケジュール HTTP ハンドラーがサービスからの競合警告を `warnings` フィールドとしてシリアライズするようにする。
    - [v] 051. (作業計画) スケジュール作成／更新ハンドラーのスタブ実装を追加し、サービスが返す警告スライスを HTTP レスポンスに含める。
- [v] 052. 仕様で説明されているとおりにアプリケーションサービス（`ScheduleService`、`RoomService`、`UserService`、認証サービス）を実装し、テスト骨組みとシグネチャを揃える。
  - [v] 053. (作業計画) `RoomService` と `UserService` のコアメソッドを実装し、管理者チェックとリポジトリ連携を追加する。
  - [v] 052a. 認証サービスの構造体と公開メソッドを定義し、将来のテストが利用するインターフェースとセンチネルエラーを整備する。
  - [v] 054. (実装) `ScheduleService.ListSchedules` のデフォルトフィルターと期間変換、競合警告伝播を実装し、関連するテスト TODO を解除する。
  - [v] 055. (実装) `ScheduleService` の JST 検証を実装し、該当テスト TODO を解除する。
  - [v] 056. (実装) `ScheduleService` の繰り返しクリーンアップ要件を実装し、該当テスト TODO を解除する。
    - [v] 056a. (作業計画) スケジュールサービスに繰り返しリポジトリ依存を追加し、更新・削除時に不要なルールを削除するテストを整備する。
    - [v] 056b. (実装) 更新・削除フローでの繰り返しクリーンアップ処理とテスト TODO の解除を行う。
- [v] 057. アプリケーションサービスがドメイン検証（必須項目、JST 時間枠、参加者の存在、管理者専用操作）を強制し、他ユーザーが作成したスケジュールを更新／削除しようとした場合の認可失敗を含め、ハンドラーが一貫して変換できるセンチネルエラーを返すようにする。
  - [v] 058. (作業計画) `RoomService`／`UserService` に必須フィールド検証とエラー整形を実装し、既存の `ScheduleService` の検証網羅性も確認する。
  - [v] 057a. (作業計画) スケジュール／ルーム／ユーザーサービスの検証・認可エッジケースを網羅するテストを有効化し、センチネルエラー伝搬を確認する。
    - [v] 057a-1. RoomService テストのスキップを解除し、管理者権限検証、必須フィールド検証、永続化エラーのマッピングを確認するケースを実装する。
    - [v] 057a-2. UserService テストのスキップを解除し、管理者権限、必須フィールド検証、メール重複エラー変換、リスト並び順を確認するケースを実装する。
    - [v] 057a-3. ScheduleService テストから認可（他ユーザー更新／削除）と検証エッジケースのスキップを外し、未知の参加者や存在しない会議室に対するセンチネルエラー伝搬を検証するケースを追加する。
  - [v] 057b. (実装) 各サービスの検証・認可ロジックとエラー整形を強化し、関連テスト TODO を解除する。
- [v] 059. 永続化レイヤー（`internal/persistence` パッケージ）を実装し、ユーザー、スケジュール、会議室、繰り返し、セッションストレージをカバーするリポジトリとマイグレーションヘルパーで統合テストを満たすようにする。参加者結合テーブルの維持、参加者ベースのスケジュールフィルタリング、繰り返し／セッション行のカスケードクリーンアップを含む。
  - [v] 059a. (作業計画) SQLite 実装にリポジトリ操作とマイグレーションヘルパーを追加し、統合テスト TODO を段階的に解除する。
    - [v] 059a-1. ストレージ初期化にセッション用マップとハーネス導線を組み込み、マイグレーションフックを保ちながらリポジトリを準備する方針を整理する。
    - [v] 059a-2. ユーザー／会議室／スケジュール／繰り返しテーブルに対する CRUD と参加者結合更新の流れをテスト観点から洗い出す計画をまとめる。
  - [v] 059b. (実装) ユーザー／会議室／スケジュール／繰り返し／セッション向けのリポジトリ実装と関連テストを完了させる。
    - [v] 059b-1. ストレージに CRUD とフィルタリング処理を実装し、既存テストが期待するエラー伝搬と順序付けを満たす。
    - [v] 059b-2. 参加者結合テーブルと繰り返しのカスケード削除が正しく動作するよう統合テストを整備し、必要な検証を追加する。
- [v] 060. `internal/persistence` にセッション永続化の契約とモデル（例：`SessionRepository`、セッション構造体）を定義し、認証サービスと HTTP ミドルウェアが具体的なストレージを配線する前に明示的なインターフェースへ依存できるようにする。
  - [v] 060a. (作業計画) セッションモデルとリポジトリインターフェースを persistence 層に追加し、アプリケーション層が依存できるようにする。
    - [v] 060a-1. セッションモデルフィールドとセンチネルエラー利用方針を整理し、既存テストで利用する ID／トークン検索 API を決める。
  - [v] 060b. (実装) セッション永続化インターフェースを定義し、関連テストスタブ／モデルを更新する。
    - [v] 060b-1. `persistence` パッケージにセッションモデルとリポジトリを追加し、SQLite 実装とテスト骨組みで利用できるようにする。
- [v] 061. `ScheduleRepository.ListSchedules` が参加者フィルターと期間制約を組み合わせ、複数ユーザーのビューや日／週／月クエリが正しいデータセットを返し、結果を時系列に整列し、要求された期間に繰り返しの展開をクリップするようにする。
  - [v] 061a. (作業計画) スケジュールリポジトリのフィルタリングと並び替え仕様をテストで定義し、SQLite 実装に反映させる。
  - [v] 061a-1. `internal/persistence/repositories_test.go` に期間境界と複数参加者を組み合わせたフィルタリングケースを追加する計画をまとめる。
  - [v] 061a-2. リポジトリの結果が開始時刻で安定ソートされることを確認する追加ケースを設計する。
  - [v] 061b. (実装) 参加者フィルターと期間制約を処理するリポジトリロジックを完成させ、テスト TODO を解除する。
  - [v] 061b-1. ストレージ内でフィルターがスケジュール作成者も一致対象に含めるよう集合処理を見直し、必要なセット演算を実装する。
  - [v] 061b-2. 期間フィルターが開始・終了境界を正しく評価するよう `filterMatchesSchedule` を調整する。
- [v] 062. `ScheduleService.ListSchedules` でデフォルトの「自分のスケジュール」セマンティクスを実装し、明示的な参加者フィルターがないリクエストでは認証済みユーザーのスケジュールのみを返し、指定がある場合は同僚の選択を尊重する。
  - [v] 062a. (作業計画) ListSchedules のデフォルト参加者フィルター挙動に対するテストを追加し、参加者指定時との分岐を整理する。
  - [v] 062a-1. `internal/application/schedule_service_test.go` に実ストレージを用いた一覧テストを追加する計画をまとめ、デフォルトビューで本人以外の予定が除外されることを確認する。
  - [v] 062a-2. 明示的な参加者指定時に選択した同僚の予定のみが返ることを確認するテスト方針を整理する。
  - [v] 062b. (実装) デフォルトフィルターと指定フィルターのロジックを実装し、テスト TODO を解除する。
  - [v] 062b-1. サービスのフィルター構築または結果整形を調整し、上記テストが通るようにする。
- [v] 063. 上記の繰り返しテストを満たす繰り返しエンジンのロジックを提供する。
  - [v] 063a. (作業計画) 繰り返しエンジンの曜日選択と期間クリッピングテストを段階的に有効化し、実装方針を固める。
  - [v] 063b. (実装) エンジンロジックを実装し、全ての繰り返しテスト TODO を解除する。
    - [v] 063a-1. Recurrence engine tests で曜日選択、期間クリッピング、タイムゾーン正規化、親スケジュール紐付けを検証する具体的なアサーションを追加する計画を記載する。
    - [v] 063b-1. `internal/recurrence` に発生生成ロジックと戻り値モデルを追加し、JST 正規化や期間フィルターを含む機能を実装する。
- [v] 064. 永続化層とアプリケーション層を拡張し、セッションストレージ／取り消し機能を実装して認証サービスのトークン発行と失効セマンティクスを支える。→ AuthService にセッション失効／削除ロジックを追加し、永続化層とテストを整備してログイン／更新／失効フローをカバーした。
  - [v] 064a. (作業計画) セッションリポジトリ操作と AuthService の連携テストを設計し、取り消し／期限切れ動作を確認する。
    - [v] 064a-1. `internal/application/auth_service_test.go` を調査し、セッション発行と失効テストの期待を洗い出す。→ `Authenticate`／`RefreshSession` ともに TODO が多数あり、成功時にセッションを返す・失効や取り消し時にセンチネルエラーへ変換するケース、更新時にトークンとメタデータを再発行するケースを準備する必要がある。
    - [v] 064a-2. セッション永続化との結合テストで使用するフィクスチャやモックの追加が必要かどうかを判断し、必要であれば設計を反映する。→ アプリケーション層テストではリポジトリスタブ（インメモリ）で十分。永続化テストには既存の `newSQLiteHarness` を拡張してセッション API をカバー済みであるため、新規フィクスチャは不要。
    - [v] 064a-3. テストで利用するセッションリポジトリインターフェースのメソッドセット（作成、検索、取り消し、期限切れ処理）と戻り値モデルを整理する。→ AuthService では Create/Get/Update へ新たに失効フロー（`RevokeSession`）と期限切れクリーンアップ（`DeleteExpiredSessions`）を追加する想定。モデルは `RevokedAt` を保持し、更新時に TTL を再計算するシナリオをテストする。
  - [v] 064b. (実装) セッション永続化と AuthService の連携処理を実装し、関連テスト TODO を解除する。
    - [v] 064b-1. AuthService がセッションリポジトリを利用してトークン作成・検証・失効を行うロジックを実装する。→ `Authenticate` の発行と `RefreshSession`／`RevokeSession` の経路で永続化クリーンアップとセンチネルエラー変換を追加した。
    - [v] 064b-2. 永続化層にセッションリポジトリ実装を追加し、作成／取得／取り消し／期限切れパスをサポートする。→ SQLite ストレージに失効処理と期限切れ削除を実装し、API が永続化契約を満たすようにした。
    - [v] 064b-3. 関連ユニットテスト／統合テストを更新し、TODO を解除する。→ AuthService と永続化リポジトリ双方のテストで新しいセッション動作を検証し、スキップしていたシナリオを有効化した。
- [v] 065. 新しいリポジトリ契約に必要なセッション永続化テーブルとサポート用インデックス（トークン検索、期限切れプルーニング）を作成するよう SQLite スキーマとマイグレーションヘルパーを更新し、認証／セッションテストが純粋な Go ドライバーで実行できるようにする。→ スキーマにセッションテーブルとインデックスを追加し、テストで定義の存在を確認した。
  - [v] 065a. (作業計画) SQLite スキーマにセッションテーブルとインデックスを追加し、マイグレーションテスト TODO を有効化する。
    - [v] 065a-1. 既存のマイグレーションファイルとテストを調べ、セッションテーブル追加に必要な変更点を列挙する。→ `internal/persistence/sqlite/schema.sql` と `sqlite_test.go` のマイグレーション検証に新テーブル・インデックスを追加する必要がある。
    - [v] 065a-2. セッションレコードに必要なカラム（ID、ユーザー、トークン、作成時刻、期限、取り消し情報など）と制約を定義する。→ 必須カラムは `id` PK、`user_id` FK、`token` UNIQUE、`fingerprint`、`expires_at`、`created_at`、`updated_at`、`revoked_at`（NULL 可）。期限切れプルーニング向けに `expires_at` へのインデックスを用意する。
  - [v] 065b. (実装) マイグレーションヘルパーを更新してセッションテーブル作成とクリーンアップ機構を提供する。
    - [v] 065b-1. マイグレーションスクリプトを更新し、セッションテーブルとインデックスを作成する SQL を追加する。→ `schema.sql` に `sessions` テーブルおよび期限切れ／ユーザー検索向けインデックスを定義した。
    - [v] 065b-2. マイグレーションテストを更新し、新しいテーブルとクリーンアップ処理が実行されることを検証する。→ `sqlite_test.go` にスキーマファイルの検証テストを追加し、テーブルとインデックスの存在を確認するようにした。
- [v] 066. パスワードハッシュをユーザーに永続化し（スキーマとリポジトリの更新）、認証サービスが資格情報を安全に検証できるようにする。→ ユーザーモデルとスキーマに `password_hash` を追加し、永続化テストで読み書きが保証されるようにした。
  - [v] 066a. (作業計画) ユーザーモデルにパスワードハッシュを保持する永続化の変更とテスト TODO を整理する。
    - [v] 066a-1. ユーザー関連の永続化コードとテストを確認し、パスワードハッシュ列追加の影響範囲を特定する。→ `internal/persistence/models.go`、`repositories.go`、`sqlite/sqlite.go` のユーザー CRUD と `AuthService` の CredentialStore 実装が影響。マイグレーションと `repositories_test.go` のユーザー検証を更新する。
    - [v] 066a-2. 認証サービスがハッシュを利用して検証するテストシナリオを計画する。→ 正常系ではハッシュ比較成功時にセッションが発行されること、異なるハッシュや空文字では `ErrInvalidCredentials` になることを検証する。ハッシュはプレースホルダーとして平文比較を利用し、将来的な bcrypt 実装に差し替え可能なようにする。
  - [v] 066b. (実装) パスワードハッシュ永続化と関連する認証テストの解除を行う。
    - [v] 066b-1. スキーマとモデルにパスワードハッシュ列を追加し、リポジトリが値を読み書きできるようにする。→ `internal/persistence/models.go`／`schema.sql`／SQLite 実装にハッシュ列を追加し、空値を拒否するようにした。
    - [v] 066b-2. 認証サービスのログインロジックを更新し、ハッシュ検証と関連テスト TODO を解除する。→ AuthService テストでハッシュ照合成功／失敗をカバーし、永続化から取得したハッシュが認証に利用されることを確認した。
- [v] 067a. （作業計画）HTTP ハンドラーのテスト TODO を洗い出し、必要なフェイクサービスやミドルウェア注入を設計して、期待するレスポンス構造を明文化する。→ 認証／ユーザー／スケジュール／ルーム各ハンドラーで確認すべきシリアライズ、警告伝播、エラーマッピング、フィルター変換を洗い出し、フェイクサービスで検証する方針を固めた。
- [v] 067b. （実装）ハンドラーとルーティングに不足している分岐やレスポンス整形を追加し、対応するテスト TODO を解除して仕様どおりのシリアライズとエラーマッピングを確認する。→ スケジュール DTO に occurrences を追加し、Principal フィルターやセンチネルエラーの HTTP 変換を網羅するテストを実装した。
- [v] 067. HTTP API ハンドラーとルーティングを実装し、計画されたコンポーネントテストに合格するようにする。対象は認証（トークンを発行するログインと取り消すログアウト）、ユーザー管理、スケジュール CRUD、会議室管理エンドポイントであり、競合警告のシリアライズ、スケジュール一覧エンドポイントにおける繰り返し展開されたペイロード、センチネルエラーをテストの期待どおりに 401／403／404／409 レスポンスへ変換すること、ユーザー向けエラーの日本語ローカライズを含む。→ `internal/http` 配下のハンドラー実装とテスト TODO を解除し、cookie／ヘッダー発行、ローカライズ済みエラー、警告・occurrence シリアライズを検証した。
- [v] 068a. （作業計画）既存の Router と DTO 実装を棚卸しし、必要なエンドポイント一覧と JSON スキーマのサマリーを作成する。→ 主要エンドポイントとレスポンス DTO を整理し、ドキュメントコメントでマッピングを明文化する方針を決めた。
- [v] 068b. （実装）Router と DTO を調整し、レスポンスの日時形式やフィールド命名を揃えた上で、テストで確認できるようドキュメントコメントを整備する。→ `internal/http/doc.go` にルーティング表を追加し、DTO に occurrences を含めて JSON 形式を安定化した。
- [v] 068. HTTP ハンドラーの実装とテストがプロダクション配線に入る前に安定した契約を共有できるよう、HTTP ルーティングマップとリクエスト／レスポンス DTO 定義を確定する。→ ルーター構成と DTO の仕様を文書化し、テストで契約を保証するようにした。
- [v] 069b. （実装）環境変数ローダーを実装し、必須設定の検証、デフォルト適用、ローカライズ済みエラー整形を提供する。→ `internal/config` に `Load` を追加し、デフォルトポート／DSN と必須セッションシークレット検証、型変換エラーの日本語メッセージを実装した。
- [v] 069. エントリポイントと依存関係の配線で使用される環境駆動の構成モジュール（検証とデフォルトを含む）を実装し、HTTP サーバー設定、SQLite DSN、認証／セッションシークレットをカバーする。→ コンフィグ構造体とローダーを導入し、テストでオプション／必須設定の組み合わせを確認した。
  - [v] 069a. （作業計画）必要な設定キーと検証ルールを列挙し、ローダーの戻り値とエラー整形方針を整理する。→ HTTP ポート、SQLite DSN、セッションシークレット、TTL、会議室上限を対象にデフォルトと検証方針を決め、ローカライズしたエラーメッセージを用意した。
- [v] 070. `log/slog` を用いた構造化ログ出力をアプリケーションサービスと HTTP ハンドラーに組み込み、コンテキスト化されたリクエスト識別子とエラー表示を含め、アーキテクチャガイダンスに合わせる。
  - [v] 070a. （作業計画）共通ロガー注入の仕組みとリクエストスコープのフィールド設計をまとめる。
    - [v] アプリケーションサービス（Schedule/Room/User/Auth）が `*slog.Logger` を受け取れるように構造体とコンストラクタを拡張し、nil の場合は `slog.Default()` をフォールバックとして利用する方針を文書化する。→ 既存の `New*Service` 各関数にロガー引数を追加し、nil 時には `slog.Default()` を利用する想定とする。
    - [v] コンテキストに格納されたリクエストロガーをサービス層で取得するヘルパー（例: `loggerFromContext(ctx, fallback)`）を定義し、リクエスト ID／エンティティ ID／プリンシパル ID をフィールドとして付与するルールをまとめる。→ `internal/application/logging.go`（新規）でヘルパーを提供し、サービスメソッドでは `With` で `principal_id`、対象 ID、操作名を出力する。
    - [v] HTTP ハンドラーはレスポンダとは別に成功・失敗を明示的に記録し、エラー時にはセンチネルエラー種別をフィールドに含めること、サービス層では永続化呼び出しの成功・失敗および検証エラーを区別したログを出力することを決める。→ ハンドラー内でサービス呼び出し前後に `logger := http.LoggerFromContext(...).With("handler", ...)` を取得し、成功時は Info、エラー時は Error で `error_kind`（`validation`, `unauthorized`, `unexpected` など）を付与する方針とする。
- [v] 071. 会議室一覧ハンドラーが、管理者権限なしでもすべての認証済みユーザーにカタログデータを公開し、スケジュール作成クライアントが選択リストを生成できるようにする。
  - [v] 071a. （作業計画）ルーム一覧エンドポイントの実装フローと必要な認可チェック、レスポンス形式を整理する。
  - [v] 071a-1. `RoomHandler.List` が認証済みユーザーのみを許可しつつ管理者権限は要求しないことを確認するテストケースと期待レスポンス（200/401）を列挙する。
  - [v] 071a-2. 認証が欠落している場合のログ／レスポンス整形および既存 DTO を再確認し、必要に応じてゼロ値 Principal の扱いを見直す。
- [v] 072. セッションリポジトリを利用する認証ミドルウェアを配線し、ハンドラーが HTTP レスポンスへ変換するドメイン固有の認可エラーを表面化し、期限切れセッションを拒否し、テストの期待どおりに一貫した 401／403 レスポンスを返すようにする。
  - [v] 072a. （作業計画）セッション検証インターフェースとミドルウェアのエラー応答、監査ログ出力の流れを整理する。
  - [v] 072a-1. 認証トークン抽出（Authorization ヘッダー／Cookie）とベアラープレフィックス検証、セッション検証サービスのエラー種別（`ErrUnauthorized`／`ErrSessionExpired`／`ErrSessionRevoked`／未知の失敗）に対する HTTP ステータスと日本語メッセージのマッピングをまとめる。
  - [v] 072a-2. `AuthService` にセッション検証メソッドを追加して `SessionValidator` を実装し、成功時に Principal を構築するためのユーザー情報取得手順を整理する。
  - [v] 072a-3. ミドルウェアテストで検証する監査ログ（成功時 Info、失敗時 Error）のフィールドと、次ハンドラーへの Principal 伝播確認ステップを明記する。
- [v] 073. 構成、リポジトリ、サービス、HTTP ルーティングを結線し、ドキュメント作成が始まる前に API をエンドツーエンドで実行できるようにする実行可能なエントリポイント（例：`cmd/scheduler`）を提供する。
  - [v] 073a. (作業計画) `cmd/scheduler` を追加し、設定読み込み、SQLite ストレージ初期化、サービス／ハンドラーの配線、HTTP サーバー起動までの流れを整理する。
  - [v] 074. アーキテクチャ概要で参照されている CGO 不要の SQLite ドライバーを選定・統合し、CI 環境で CGO 依存なしにマイグレーションとリポジトリ実装が動作するようにする。
    - [v] 074a. (作業計画) ピュア Go のデータストア実装に切り替えて DSN 正規化や初期化要件を整理し、`Open` 周辺の振る舞いを CGO なしで再構成する。
  - [v] 075. 既存の `internal/persistence/sqlite` パッケージをリファクタリングし、現在の CGO バインディングを排除して、選択した純粋な Go ドライバーへリポジトリメソッドとテストを移植し、ネイティブの SQLite ライブラリなしでコードベースがビルド／実行できるようにする。
    - [v] 075a. (作業計画) 既存の `Storage` 実装を純粋な Go 構造体ベースへ書き換える際に必要な CRUD 処理とヘルパーの移行順序を定義する。
  - [v] 076. `internal/persistence/sqlite` の手作り CGO ステートメントヘルパーを、選択したドライバーが提供する `database/sql` バックエンド実装に置き換え、DSN ハンドリング（`normalizeDSN`）、PRAGMA 設定、参加者の重複排除、トランザクション整合性チェックを維持しつつ、`*sql.DB` の接続プール／ビジータイムアウト設定とコンテキスト対応のクエリ／トランザクション API を使用して、CGO バックエンドと同じ同時実行保証を確保する。
    - [v] 076a. (作業計画) `normalizeDSN` や初期化処理を純粋な Go 実装に移すためのヘルパー設計と、参加者重複排除ロジックをストレージ層で担保する方法を整理する。
  - [v] 077. 新しい `database/sql` 永続化がスケジュール更新時に不変フィールド（`creator_id`、`created_at`）を保護する既存のトランザクションセマンティクスを維持し、メールアドレスの大文字小文字を区別しない検索、ソート済みの参加者リストを保持して、ステップ1の順序付け／重複排除骨組みを通過させるようにする。
  - [v] 078. 繰り返しリポジトリを `database/sql` に移植し、既存の `CreatedAt` 保存ルール、曜日ビットマスクエンコード、RFC3339 日付保存を引き継ぎ、`StartsOn`／`EndsOn` の挙動と順序付きリストを観測するテストが引き続き成功するようにする。
  - [v] 079. 新しい `database/sql` ストレージが、スケジュール、繰り返し、セッションの日時をバインド／スキャンする際に既存の UTC `time.RFC3339Nano` タイムスタンプエンコードを保持し、下流のサービスで時間演算が一貫するようにする。
  - [v] 080. 純粋な Go ストレージで繰り返しの曜日エンコード／デコードヘルパーを再導入し、`[]time.Weekday` の値が既存の整数ビットマスクとして永続化され、リポジトリ結果で正確に読み戻されるようにする。
- [v] 081. CGO バインディングを除去すると `sqlite3_exec` の複数ステートメント便利機能が使えなくなるため、埋め込みスキーマ文を `database/sql` 経由で分割実行するように SQLite マイグレーションヘルパーを書き換える。→ スキーマを `go:embed` で読み込み、`splitSQLStatements`／`runStatements` でコメント除去と逐次実行を行い、テストで分割結果を確認した。
  - [v] 081a. （作業計画）`internal/persistence/sqlite` のマイグレーション実装を洗い出し、スキーマ SQL をステートメント単位で実行するヘルパーの責務と I/O を整理する。→ `Storage` の `Migrate` を `database/sql` のコネクションへ差し替え、埋め込み済み `schema.sql` を読み込んで逐次実行する `runStatements(ctx, db, schema)` ヘルパーを新設する。
  - [v] 081b. （作業計画）スキーマ分割ロジックとテスト戦略（空白行やコメントを含む複数ステートメントの検証）を設計し、`sqlite_test.go` の期待を更新する。→ セミコロン終端で区切りつつコメント／空行を無視し、分割ヘルパーのユニットテストと `Migrate` 経由の結合テストを追加する。
  - [v] 082. `CGO_ENABLED=0` で新しい `database/sql` ストレージを検証し、C ベースヘルパーを削除しつつ、ドライバー固有のエラー対応やトランザクション動作を主張するように `internal/persistence/sqlite/sqlite_test.go`（および関連フィクスチャ）を書き換え、移行後もリグレッションカバレッジを維持する。
- [v] 083. `go.mod`、インポート、ビルド配線を更新して選択した純粋な Go SQLite ドライバーに依存させ、従来の `import "C"` を除去し、モジュールが `CGO_ENABLED=0` でビルドできることを確認する。→ `modernc.org/sqlite` をローカル純粋 Go ドライバーとして追加し、`go.mod` の `replace` と `require` を更新した上で、`CGO_ENABLED=0 go test ./...` を実行して依存が CGO なしで通ることを確認した。
  - [v] 083a. （作業計画）採用する純粋 Go ドライバー（例: `modernc.org/sqlite`）の依存と初期化手順、`database/sql` で利用するための接続名を調査する。→ `modernc.org/sqlite` をブランクインポートし、`sql.Open("sqlite", dsn)` で利用する。DSN は `file:<abs>?cache=shared&_pragma=foreign_keys(ON)&_pragma=busy_timeout(5000)` をベースにし、接続プールは 1 コネクションに制限する。
  - [v] 083b. （作業計画）`go.mod` とストレージ実装のインポートを更新し、`CGO_ENABLED=0` で `go test ./...` が通ることを確認する段取りをまとめる。→ `go.mod` にローカルドライバーを追加してストレージの `sql.Open` へ配線し、CGO 無効でテストを実行して成功を確認した。
  - [v] 084. `internal/persistence/errors.go` に重複や外部キー違反などの追加の永続化センチネルエラーを導入し、リポジトリがドライバーエラーをそれらにマッピングして、サービスがデータベース制約違反を一貫した HTTP レスポンスへ変換できるようにする。
  - [v] 085. SQLite スキーマ（および純粋な Go マイグレーション）を強化し、`end_at > start_at`、正の会議室収容人数、逆行しない繰り返し期間を強制する `CHECK` 制約を追加し、新しい `database/sql` リポジトリがこれらの違反を上記の検証センチネルエラーへ変換するように配線する。
  - [v] 086. 参加者フィルターと期間クエリが高性能のままであるよう、純粋な Go ドライバーへ移植する際に SQLite マイグレーションで参加者検索や開始／終了タイムスタンプに対する補助インデックスを追加する。
- [v] 087. アーキテクチャ計画で説明されている単一バイナリのスケジューラーを出力するマルチステージビルドの Dockerfile を作成し、後のデプロイや手動検証を円滑にする。
  - [v] 087a. （作業計画）マルチステージ Dockerfile の構成とビルドターゲットを整理し、エントリポイント（`cmd/scheduler`）をビルドする手順を決める。

## 支援インフラ
- [v] 088. 今後のテストを支援するため、`internal/testfixtures` に再利用可能で決定論的なフィクスチャ／ビルダーを作成する。
  - [v] 088a. （作業計画）アプリケーション／永続化テストで繰り返し利用するユーザー・会議室・スケジュールのビルダー API と決定論的 ID 戦略を設計する。
- [ ] 089. 永続化テスト骨組みで参照される一時的な SQLite ヘルパー（マイグレーション、クリーンアップ）を整備する。
- [ ] 090. アプリケーションサービスが本番インフラなしでテスト内でインスタンス化できるよう、（最小限でも）依存性注入の配線を導入する。
- [ ] 091. スケジュール、繰り返し、セッション期限ロジックがテスト下で決定論的に保たれるよう、制御可能なクロック／テスト時間ヘルパーを提供する。
- [ ] 092. `go test ./...` の実行、レースデテクタ、`golangci-lint` を走らせる CI 自動化（例：GitHub Actions）を整備し、`go.mod` に合わせて Go 1.22 を固定し、合意されたテスト戦略に沿ったベースライン `.golangci.yml` をコミットする。
- [ ] 093. アプリケーションおよび永続化パッケージのステートメントカバレッジが 80% を下回った場合にビルドを失敗させる CI 自動化を拡張し、テスト戦略ドキュメントのカバレッジ目標に合わせる。
- [ ] 094. 純粋な Go SQLite ドライバーが整備された後に CGO 依存が再導入されるリグレッションを防ぐため、`CGO_ENABLED=0` でテストスイート全体を実行する CI ジョブを追加する。

## ステータス追跡
- 作業が進むにつれてこのチェックリストを更新し、上記の項目が実装され、すべてのテストがグリーンになった後にのみステップ3を開始する。
