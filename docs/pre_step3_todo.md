# Pending Work Before Step 3

This list captures the outstanding tasks that must be completed during Steps 1 and 2 (test-first development and implementation/refinement) before advancing to Step 3 (documentation and review).

## Test Scaffolding (Step 1)
- [ ] Flesh out failing test skeletons for the Schedule application service methods (`CreateSchedule`, `UpdateSchedule`, `ListSchedules`, `DeleteSchedule`) that cover creator immutability, administrator overrides, validation of start/end windows and required fields (including web conference URL format), verifying participant and room existence, creating schedules on behalf of other users, and allowing hybrid meetings that simultaneously set physical room and web conference information.
- [ ] Extend Schedule service test scaffolds with cases that assert participant filters, multi-user list views, recurrence expansion hooks, propagation of conflict warnings from the detector, chronological ordering of returned schedules, cleanup of linked recurrences when schedules are updated or deleted, enforcement of JST-only scheduling, translation of day/week/month timeframe filters (`StartsAfter`/`EndsBefore`) into the correct result set, and success paths that still persist updates when conflicts are reported.
- [ ] Describe `ListSchedules` test scaffolds that ensure the default view (no explicit participant filter) returns only the authenticated user's schedules while explicit participant filters allow viewing colleagues, matching the "My schedule" vs. "Selected colleagues" requirement without leaking unintended records.
- [ ] Add Schedule service test scaffolds that cover authorization failures for non-creators attempting updates or deletes, administrator override success paths, and consistent `ErrUnauthorized`/`ErrNotFound` propagation for missing schedules.
- [ ] Add unit-test scaffolds covering `RoomService` CRUD behavior, including administrator-only access constraints and validation of required attributes (name, location, positive capacity).
- [ ] Capture `RoomService.ListRooms` scaffolds that assert read access is available to all authenticated employees (not only administrators) so schedule creation flows can surface the catalog.
- [ ] Create unit-test scaffolds for administrator-only user management service methods (`CreateUser`, `UpdateUser`, `ListUsers`, `DeleteUser`) that validate input handling and privilege enforcement.
- [ ] Draft unit-test scaffolds for the authentication service, including password hashing edge cases, lockout behavior (if retained), session/token issuance flows, and sentinel errors for invalid credentials or disabled accounts.
- [ ] Tighten conflict detection unit-test scaffolds in `internal/scheduler` to describe overlapping participant and room intervals, identical-ID short-circuit behavior, and non-overlap baselines before wiring services to the detector.
- [ ] Expand conflict detection scaffolds to cover schedules that simultaneously overlap on both participants and rooms so the detector returns every applicable warning in a single evaluation.
- [ ] Describe HTTP middleware/component tests that assert session token validation and propagation of the authenticated principal into handler contexts.
- [ ] Introduce recurrence engine test outlines that describe weekday selection, timezone handling, clipping generated occurrences to requested timeframes, and generated occurrence linking.
- [ ] Define persistence adapter test scaffolds (repositories for users, schedules, rooms, recurrences, and authentication data), including integration test placeholders using SQLite fixtures, coverage for foreign-key cascades, and translation of uniqueness/lookup violations into sentinel errors.
- [ ] Extend persistence adapter scaffolds to assert invalid records are rejected (e.g., schedules whose `End` is not after `Start`, rooms with non-positive capacity, recurrences whose `EndsOn` precedes `StartsOn`) and that repositories surface the validation sentinel errors planned for these constraint failures.
- [ ] Extend persistence adapter scaffolds to assert `GetUserByEmail` performs case-insensitive lookups, repository list operations (`ListUsers`, `ListRooms`, `ScheduleRepository.ListSchedules`) return deterministically ordered results, and schedule participant collections come back sorted/deduplicated.
- [ ] Add recurrence repository scaffolds that verify `UpsertRecurrence` preserves the original `CreatedAt` timestamp on updates, round-trips `StartsOn`/`EndsOn` boundaries without timezone drift, and that `ListRecurrencesForSchedule` returns rules ordered by creation time.
- [ ] Expand SQLite storage test scaffolds to capture DSN normalisation, `PRAGMA foreign_keys` enforcement, and transactional rollback semantics currently encoded in `internal/persistence/sqlite` so the pure-Go driver refactor maintains those behaviours.
- [ ] Add SQLite storage test scaffolds that assert timestamp columns continue to round-trip via UTC `time.RFC3339Nano` text so the database/sql migration does not regress timezone handling or truncate precision.
- [ ] Extend SQLite storage test scaffolds to cover recurrence weekday bitmask encoding so multi-day selections round-trip between `[]time.Weekday` and the integer column when ported to the pure-Go driver.
- [ ] Add persistence test scaffolds for session management repositories covering token creation, lookup, expiration, and revocation behavior.
- [ ] Outline component-test scaffolds for HTTP handlers (authentication, user management, schedules, rooms) to validate request validation, authorization (including 403 responses for non-creators), response shaping, login responses that set session tokens (cookie/header), logout flows that revoke sessions, surfacing of conflict warnings and recurrence-expanded results, and returning localized (Japanese) error and validation messages per the specification.
- [ ] Add HTTP handler test scaffolds for schedule listing that cover the default personal view, explicit colleague selections, translation of `ErrNotFound`/`ErrUnauthorized` sentinel errors into `404`/`403` responses for missing or forbidden schedule resources, and correct day/week/month query parameter mapping (including Monday-start week windows and default daily time spans) into service timeframe filters.
- [ ] Capture configuration loader test scaffolds that assert environment variable parsing, default fallback behavior, and validation of required settings (HTTP port, SQLite DSN, session secrets) so Step 2 work can proceed test-first.

## Implementations to Unblock Green Phase (Step 2)
- [ ] Wire the existing conflict-detection logic into schedule creation/update flows so conflict warnings surface in service and handler responses while still persisting changes when warnings are present, matching the "warnings don't block" rule.
- [ ] Implement the application services (`ScheduleService`, `RoomService`, `UserService`, authentication service) as described in the specification, aligning signatures with the test scaffolding.
- [ ] Ensure application services enforce domain validations (required fields, JST time windows, participant existence, admin-only operations) and return sentinel errors that handlers can translate consistently, including unauthorized attempts to update/delete schedules created by other users.
- [ ] Implement the persistence layer (`internal/persistence` package) with repositories and migration helpers to satisfy integration tests, covering users, schedules, rooms, recurrences, and session storage, including maintaining the participant join table, participant-based filtering for schedules, and cascading cleanup of recurrence/session rows.
- [ ] Define session persistence contracts and models in `internal/persistence` (e.g., `SessionRepository`, session structs) so the authentication service and HTTP middleware can depend on explicit interfaces before wiring concrete storage.
- [ ] Ensure `ScheduleRepository.ListSchedules` combines participant filters and timeframe constraints so multi-user views and day/week/month queries return the correct data set, orders results chronologically, and clips recurrence expansions to the requested window.
- [ ] Implement the default "my schedule" semantics in `ScheduleService.ListSchedules` so requests without explicit participant filters only return the authenticated user's schedules while honoring colleague selections when provided.
- [ ] Provide recurrence engine logic that satisfies the outlined recurrence tests.
- [ ] Extend persistence and application layers with session storage/revocation to back the authentication service's token issuance and expiration semantics that middleware will enforce.
- [ ] Update the SQLite schema and migration helper to create the session persistence tables and supporting indexes (token lookup, expiry pruning) required by the new repository contracts so authentication/session tests can run against the pure-Go driver.
- [ ] Persist password hashes for users (schema + repository updates) so that the authentication service can verify credentials securely.
- [ ] Implement HTTP API handlers and routing that pass the planned component tests, covering authentication (login issuing tokens + logout revocation), user management, schedule CRUD, and room management endpoints, including conflict warning serialization, recurrence-expanded payloads for schedule listing endpoints, translation of sentinel errors into 401/403/404/409 responses per test expectations, and localized Japanese messaging for user-facing errors.
- [ ] Finalize the HTTP routing map and request/response DTO definitions so handler implementations and tests share stable contracts before production wiring begins.
- [ ] Implement an environment-driven configuration module (with validation and defaults) consumed by the entry point and dependency wiring, covering HTTP server settings, SQLite DSN, and authentication/session secrets.
- [ ] Instrument application services and HTTP handlers with structured logging via `log/slog`, including contextual request identifiers and error surfaces, matching the architecture guidance.
- [ ] Ensure room listing handlers expose catalog data to all authenticated users so schedule creation clients can populate selection lists without administrator privileges.
- [ ] Wire authentication middleware that consumes the session repository and surfaces domain-specific authorization errors for handlers to translate into HTTP responses, rejecting expired sessions, and returning consistent 401/403 responses per test expectations.
- [ ] Provide an executable entry point (e.g., `cmd/scheduler`) that wires configuration, repositories, services, and HTTP routing so the API can run end-to-end before documentation begins.
- [ ] Select and integrate the cgo-free SQLite driver referenced in the architecture overview, ensuring migrations and repository implementations can run in CI environments without CGO dependencies.
- [ ] Refactor the existing `internal/persistence/sqlite` package to drop the current CGO bindings, porting repository methods and their tests to the selected pure-Go driver so the codebase builds and runs without native SQLite libraries.
- [ ] Replace the hand-rolled CGO statement helpers in `internal/persistence/sqlite` with a `database/sql` backed implementation provided by the chosen driver, preserving DSN handling (`normalizeDSN`), PRAGMA configuration, participant de-duplication, and transactional integrity checks verified by the expanded tests while configuring the `*sql.DB` connection pool/busy timeout settings and using context-aware query/transaction APIs so concurrency guarantees match the CGO-backed storage.
- [ ] Ensure the new `database/sql` persistence keeps the current transaction semantics that protect immutable fields (`creator_id`, `created_at`) during schedule updates, maintains case-insensitive email lookups, and retains sorted participant lists so Step 1 ordering/deduplication scaffolds pass.
- [ ] Port the recurrence repository to `database/sql` while carrying forward the existing `CreatedAt` preservation rules, weekday bitmask encoding, and RFC3339 date storage so tests observing `StartsOn`/`EndsOn` behaviour and ordered listing continue to succeed.
- [ ] Ensure the new `database/sql` storage preserves the existing UTC `time.RFC3339Nano` timestamp encoding when binding and scanning schedule, recurrence, and session datetimes so downstream services keep consistent time arithmetic.
- [ ] Reintroduce recurrence weekday encoding/decoding helpers in the pure-Go storage so `[]time.Weekday` values persist as the existing integer bitmask and reload accurately in repository results.
- [ ] Rework the SQLite migration helper to split and execute the embedded schema statements through `database/sql` since the previous `sqlite3_exec` multi-statement convenience is no longer available once CGO bindings are removed.
- [ ] Rewrite `internal/persistence/sqlite/sqlite_test.go` (and related fixtures) to exercise the new `database/sql` storage with `CGO_ENABLED=0`, removing the C-based helpers while asserting driver-specific error mapping and transaction behaviour so regression coverage persists after the migration.
- [ ] Update `go.mod`, imports, and build wiring to rely on the selected pure-Go SQLite driver, remove the legacy `import "C"` surface, and confirm the module builds with `CGO_ENABLED=0`.
- [ ] Introduce additional persistence sentinel errors (e.g., duplicates, foreign-key violations) in `internal/persistence/errors.go` and ensure repositories map driver errors onto them so services can translate database constraint failures into consistent HTTP responses.
- [ ] Strengthen the SQLite schema (and its pure-Go migration) with `CHECK` constraints enforcing `end_at > start_at`, positive room capacities, and non-regressive recurrence windows while wiring the new `database/sql` repositories to translate those violations into the validation sentinel errors added above.
- [ ] Add supporting indexes in the SQLite migrations (participant lookups and start/end timestamps) when porting to the pure-Go driver so participant filters and timeframe queries in `ScheduleRepository.ListSchedules` remain performant.
- [ ] Produce a Dockerfile with a multi-stage build that outputs the single-scheduler binary described in the architecture plan to smooth later deployment and manual verification.

## Supporting Infrastructure
- [ ] Create reusable deterministic fixtures/builders in `internal/testfixtures` to support the upcoming tests.
- [ ] Establish a temporary SQLite helper for integration tests (migrations, cleanup) referenced by the persistence test scaffolding.
- [ ] Introduce dependency injection wiring (even minimal) so that application services can be instantiated in tests without production infrastructure.
- [ ] Provide a controllable clock/test time helper so schedule, recurrence, and session expiry logic remain deterministic under test.
- [ ] Establish CI automation (e.g., GitHub Actions) that runs `go test ./...` with the race detector and `golangci-lint`, and commit a baseline `.golangci.yml` aligned with the agreed test strategy while pinning Go 1.22 to match `go.mod`.
- [ ] Extend CI automation to fail the build when statement coverage for application and persistence packages drops below 80%, matching the coverage target in the test strategy document.
- [ ] Add a CI job that executes the full test suite with `CGO_ENABLED=0` to guard against regressions that would reintroduce CGO dependencies once the pure-Go SQLite driver is in place.

## Status Tracking
- Update this checklist as work progresses to ensure Step 3 only begins after the above items are implemented and all tests are green.
